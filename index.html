<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <title>Máy tính bỏ túi</title>
    <link href="style.css" rel="stylesheet">
    <link href="baseStyle.css" rel="stylesheet">
</head>

<body>
<p id="titleArea">Máy tính bỏ túi</p>

<div id="boardArea">
    <input id="inputArea">
    <hr>
    <p id="resultArea"></p>
</div>

<table id="tableArea"></table>
</body>
</html>

<script>
    let inputs = [['AC', 'C', '÷', 7, 8, 9],
        ['(', ')', '×', 4, 5, 6],
        ['%', '‰', '-', 1, 2, 3],
        ['√', '^', '+', '.', 0, '=']];
    let inputArea = document.getElementById('inputArea');
    let resultArea = document.getElementById('resultArea');
    let tableArea = document.getElementById('tableArea');

    for (let i = 0; i < inputs.length; i++) {
        let tableRow = document.createElement('tr');
        tableArea.appendChild(tableRow);

        for (let j = 0; j < inputs[i].length; j++) {
            let button = document.createElement('button');
            button.innerHTML = String(inputs[i][j]);
            if (button.innerHTML.match(/[0-9]/)) {
                button.className = 'buttonNumber';
            } else {
                button.className = 'buttonCalculus';
            }

            let tableCell = document.createElement('td');
            tableCell.appendChild(button);
            tableRow.appendChild(tableCell);

            switch (button.innerHTML) {
                default:
                    button.onclick = function () {
                        input(button.innerHTML);
                    };
                    break;
                case 'C':
                    button.onclick = clearRight;
                    break;
                case 'AC':
                    button.onclick = clearAll;
                    break;
                case '=':
                    button.onclick = result;
                    break;
            }
        }
    }

    window.onkeydown = function (event) {
        inputArea.setCustomValidity('');
        event.preventDefault();
        switch (event.key) {
            case String(event.key.match(/[0-9.,+\-*/%()^]/)):
                input(event.key);
                break;
            case 'Backspace':
                clearRight();
                break;
            case 'Delete':
                clearLeft();
                break;
            case 'Clear':
                clearAll();
                break;
            case 'Enter':
                result();
                break;
        }
    }

    function input(key) {
        inputArea.value += key.replace('×', '*')
            .replace('÷', '/')
            .replace('√', '√(')
            .replace('^', '^(');
        resultArea.innerHTML = '';
    }

    function clearRight() {
        inputArea.value = inputArea.value.substring(0, inputArea.value.length - 1);
        resultArea.innerHTML = '';
    }

    function clearLeft() {
        inputArea.value = inputArea.value.substring(1);
        resultArea.innerHTML = '';
    }

    function clearAll() {
        inputArea.value = '';
        resultArea.innerHTML = '';
    }

    function result() {
        let formatValue = format(inputArea.value);
        inputArea.value = formatValue.replaceAll('Math.sqrt(', '√\(');

        try {
            let result = eval(formatValue);
            if (formatValue.includes('^')) {
                let caretAmount = (formatValue.match(/\^/g)).length;
                let powers = formatValue.split('^');
                if (caretAmount >= 2) {
                    inputArea.setCustomValidity('Biểu thức chỉ thực hiện 1 phép lũy thừa.');
                    inputArea.reportValidity();
                } else {
                    resultArea.innerHTML = String(Math.pow(eval(powers[0]), eval(powers[1])));
                }
            } else if (typeof (result) === 'number') {
                resultArea.innerHTML = String(result);
            } else {
                inputArea.setCustomValidity('Biểu thức không hợp lệ.');
                inputArea.reportValidity();
            }
        } catch {
            inputArea.setCustomValidity('Biểu thức không hợp lệ.');
            inputArea.reportValidity();
        }
    }

    function format(inputValue) {
        let reMinus = inputValue.match(/(-)\1+/g);
        if (reMinus !== null) {
            for (let i = 0; i < reMinus.length; i++) {
                inputValue = reMinus[i].length % 2 === 0
                    ? inputValue.replace(reMinus[i], '+')
                    : inputValue.replace(reMinus[i], '-');
            }
        }
        return inputValue.replaceAll('%', '/100')
            .replaceAll('‰', '/1000')
            .replaceAll('√\(', 'Math.sqrt(')
            .replaceAll(',', '.')
            .replace(/(\+)\1+/g, '+')
            .replace(/(\*)\1+/g, '*')
            .replace(/(\/)\1+/g, '/')
            .replace(/(\.)\1+/g, '.');
    }
</script>