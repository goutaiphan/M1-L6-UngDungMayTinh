<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Ứng dụng Máy tính bỏ túi</title>
    <link href="style.css" rel="stylesheet">
</head>

<body>
<p id="titleArea">Ứng dụng<br>Máy tính bỏ túi</p>

<div id="group">
    <input id="inputArea">
    <hr>
    <p id="resultArea"></p>
</div>

<table id="tableArea"></table>
</body>
</html>

<script>
    let inputs = [['AC', 'C', '÷', 7, 8, 9],
        ['(', ')', '×', 4, 5, 6],
        ['%', '‰', '-', 1, 2, 3],
        ['√', '^', '+', '.', 0, '=']];
    let inputArea = document.getElementById('inputArea');
    let resultArea = document.getElementById('resultArea');
    let tableArea = document.getElementById('tableArea');

    for (let i = 0; i < inputs.length; i++) {
        let tableRow = document.createElement('tr');
        tableArea.appendChild(tableRow);

        for (let j = 0; j < inputs[i].length; j++) {
            let button = document.createElement('button');
            button.innerHTML = String(inputs[i][j]);
            if (button.innerHTML.match(/[0-9]/)) {
                button.className = 'buttonNumber';
            } else {
                button.className = 'buttonCalculus';
            }

            let tableCell = document.createElement('td');
            tableCell.appendChild(button);
            tableRow.appendChild(tableCell);

            switch (button.innerHTML) {
                default:
                    button.onclick = input;
                    break;
                case 'C':
                    button.onclick = clear;
                    break;
                case 'AC':
                    button.onclick = allClear;
                    break;
                case '=':
                    button.onclick = result;
                    break;
            }
        }
    }

    window.onkeydown = function (event) {
        event.preventDefault();
        switch (event.key) {
            case String(event.key.match(/[0-9.,+\-*/%()^]/)):
                input();
                break;
            case 'Backspace':
                clear();
                break;
            case 'Delete':
            case 'Clear':
                allClear();
                break;
            case 'Enter':
                result();
                break;
        }
    }

    function input() {
        let inputValue = this.innerHTML !== undefined ? this.innerHTML : this.event.key;
        inputArea.value += inputValue.replace('×', '*')
            .replace('÷', '/')
            .replace('√', '√(')
            .replace('^', '^(');
        resultArea.innerHTML = '';
    }

    function clear() {
        inputArea.value = inputArea.value
            .substr(0, inputArea.value.length - 1);
        resultArea.innerHTML = '';
    }

    function allClear() {
        inputArea.value = '';
        resultArea.innerHTML = '';
    }

    function result() {
        let formatValue = format(inputArea.value);
        // inputArea.value = formatValue;
        // resultArea.innerHTML = eval(formatValue);

        if (formatValue === '' || formatValue[0].match(/[^0-9+\-(√M]/)) {
            inputArea.setCustomValidity('Biểu thức không hợp lệ.');
            inputArea.reportValidity();
        } else if (formatValue.includes('^')) {
            let caretCount = (formatValue.match(/\^/g)).length;
            let powers = formatValue.split('^');
            if (caretCount >= 2) {
                inputArea.setCustomValidity('Biểu thức chỉ thực hiện 1 phép lũy thừa.');
                inputArea.reportValidity();
            } else {
                try {
                    resultArea.innerHTML = String(Math.pow(eval(powers[0]), eval(powers[1])));
                } catch (e) {
                    inputArea.setCustomValidity('Biểu thức không hợp lệ.');
                    inputArea.reportValidity();
                }
            }
        } else {
            try {
                inputArea.value = formatValue.replaceAll('Math.sqrt(', '√\(');
                resultArea.innerHTML = eval(formatValue);
            } catch (e) {
                inputArea.setCustomValidity("Biểu thức không hợp lệ.");
                inputArea.reportValidity();
            }
        }
    }

    function format(inputValue) {
        let reMinus = inputValue.match(/(-)\1+/g);
        if (reMinus !== null) {
            for (let i = 0; i < reMinus.length; i++) {
                inputValue = reMinus[i].length % 2 === 0
                    ? inputValue.replace(reMinus[i], '+')
                    : inputValue.replace(reMinus[i], '-');
            }
        }

        inputValue = inputValue.replaceAll('%', '/100')
            .replaceAll('‰', '/1000')
            .replaceAll('√\(', 'Math.sqrt(')
            .replaceAll(',', '.')
            .replace(/(\+)\1+/g, '+')
            .replace(/(\*)\1+/g, '*')
            .replace(/(\/)\1+/g, '/')
            .replace(/(\.)\1+/g, '.');
        return inputValue;
    }
</script>